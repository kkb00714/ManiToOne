<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" th:href="@{/style/reset.css}"/>
  <link rel="stylesheet" th:href="@{/style/common.css}"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
  />
  <link rel="icon" type="image/x-icon" th:href="@{/images/favicon/favicon.ico}">
  <title>ManiToOne</title>
</head>
<body>
<section class="sign-in-section">
  <div class="logo-box">
    <img th:src="@{/images/logo/long-logo.png}" alt="ManiToOne logo"/>
  </div>
  <div class="sign-in-container">
    <form>
      <div class="sign-in-input-container">
        <input
            class="sign-in-input"
            type="text"
            name="user-id"
            id="user-id"
            placeholder="사용자 아이디"
            aria-label="사용자 아이디"
        />
        <input
            class="sign-in-input"
            type="password"
            name="user-password"
            id="user-password"
            placeholder="비밀번호"
            aria-label="비밀번호"
        />
        <button class="sign-in-button">로그인</button>
      </div>
    </form>
  </div>
  <div class="find-password-link-container">
    <p>비밀번호를 잊으셨나요?</p>
    <p class="find-password-link"><a th:href="@{/find-password}">찾기</a>
    </p>
  </div>
  <div class="sign-in-devider">
    <hr class="sign-in-devider-line"/>
    <p>또는</p>
    <hr class="sign-in-devider-line"/>
  </div>
  <div class="external-login-container">
    <!--    <button class="kakao-login">-->
    <!--      <img-->
    <!--          th:src="@{/images/logo/external-login-logo/google-login.png}"-->
    <!--          alt=""-->
    <!--      />-->
    <!--    </button>-->
    <button class="google-login">
      <a th:href="@{/oauth2/authorization/google}" class="google-login">
        <img th:src="@{/images/logo/external-login-logo/google-login.png}" alt="Google 로그인"/>
      </a>
    </button>
  </div>
  <div class="sign-up-link-container">
    <p>계정이 없으신가요?</p>
    <p class="sign-up-link"><a th:href="@{/register}">회원가입</a></p>
  </div>
</section>

<script>
  document.querySelector(".sign-in-button").addEventListener("click", function (event) {
    event.preventDefault();

    const userId = document.getElementById("user-id").value;
    const password = document.getElementById("user-password").value;

    // 입력값 검증
    if (!userId || !password) {
      alert("아이디와 비밀번호를 확인해주세요.");
      return;
    }

    const loginData = {
      email: userId,
      password: password,
    };

    fetch('/api/local-login', {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(loginData),
      credentials: "include",
    })
    .then(response => {
      if (response.ok) {
        return response.json();  // 정상적인 응답은 JSON으로 처리
      } else {
        return response.json().then(errorResponse => {
          // 오류가 JSON 형태로 반환되면 여기에 처리
          throw new Error(errorResponse.error || "알 수 없는 오류");
        });
      }
    })
    .then(user => {
      if (user && user.nickname) {
        localStorage.setItem("isRead", user.read);
        alert(`로그인 성공! 환영합니다, ${user.nickname} 님.`);
        window.location.href = "/";
      } else {
        throw new Error("user를 찾을 수 없습니다.");
      }
    })
    .catch(error => {
      alert("로그인 실패: " + error.message);
    });
  });
  document.querySelector(".google-login").addEventListener("click", function () {
    fetch('/api/oauth-login', {
      method: "GET",
      credentials: "include",
    })
    .then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error("OAuth2 인증 실패");
      }
    })
    .then(user => {
      alert(`OAuth 로그인 성공! 환영합니다, ${user.nickname} 님.`);
      window.location.href = "/";
    })
    .catch(error => {
      alert("OAuth 로그인 실패: " + error.message);
    });
  });

</script>
</body>
</html>
